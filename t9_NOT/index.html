<html>
<head>
<style>
#numpad { width:380px; position:absolute; top:120px; touch-action: manipulation;}
#output { font-size:30px; position:absolute; left:500px; top:200px;
          border-width:10px; border-radius:25px; border-color:#FF00FF; width: 390px;}
#showLetter { font-size:48px; position:absolute; left:500px; top:120px;
              border-width:10px; border-style:solid; width:370px; 
              border-radius:20px; border-color:#FFAA00;}
.buttonClass01 {transition-duration: .4s; font-size:26px; 
                border:6px solid; border-radius:20px; border-color:#FFAA00;}
.buttonClass01:hover { background-color: #FF00FF; color: white;}
</style>
</head>

<body onload='displayNumPad()'>

<div style="font-size:20px; max-height:105px; min-width:370px; overflow-y:auto;">
Press on Keypad to generate old fashioned text <br>
Long Press for Numbers <br>
Short Press 0 for Space, Short Press # for Back Space <br>
Refresh Page to Reset *<br><br>
</div>

<div id='numpad'>
</div>

<div id='showLetter'>Letter:</div>

<div id='o1'>
  <textarea id="output" rows="4" cols="20">
  </textarea>
</div>

</body>


<script>
"use strict"

function makeKeyCounts () {

    //long winded amount of code to generate lookup tables
    //for an old cell phone keypad, somewhat generalizeable though
    const aOffset=65; //A=65
    let numP = {}; //number of presses per numeric key to get alpha key
    let invP = {}; //the numeric key pressed per alpha key
    let count = 0, count2 = 0;
    let whichKey = 2;
    for (let i=0;i<26;i++) {
        const letter = String.fromCharCode(i+aOffset);
        numP[letter] = count%3 + 1;
        count ++; count2 ++;
        //only 2 special cases: S and Z
        if ('SZ'.includes(letter))
            {numP[letter]=4; count=0;
            count2--; whichKey--;}

        invP[letter] = whichKey;
        if (count2%3==0) whichKey ++;
    }
    //no reason not to include the special characters
    numP[' '] = 1; numP['*'] = 1; numP['#'] = 1;

    //let's just deal with numbers as strings
    const zeroOffset=48; //0=48
    for (let i=0; i<10; i++) {
        const letter = String.fromCharCode(i+zeroOffset);
        numP[letter] = 1;
    }

    let lettersByKey = {};
    const kk = Object.keys(invP);
    for (let i=0; i<kk.length; i++) {
        const [letter,keynum] = [ kk[i],invP[kk[i]] ];
        if ( !lettersByKey[keynum] ) lettersByKey[keynum]=[];
        lettersByKey[keynum].push(letter);
    }
    lettersByKey['0'] = ['\u00A0'];
    //if we want multiple spaces in html we need the &nbsp whitespace
    //character which is \u00A0 in hex  
    lettersByKey['*'] = ['*'];  
    lettersByKey['#'] = ['#'];
    lettersByKey['1'] = ['1'];

    return [numP, invP, lettersByKey];
}

const presses = (strIn) => {
    let numP = 0;
    const strUC = strIn.toUpperCase();
    for (let i=0;  i<strUC.length; i++) {
        //?? nullish coalescing does not exist here so I use ||
        //to fall back if for some reason we get a strange character
        //not in the lookup table
        numP += keyP[strUC[i]] ?? 0;
    }
    return numP;
}

function checkPresses() {

    //document.getElementById("textarea").scrollTop = document.getElementById("textarea").scrollHeight 

    const ln = np.presses.length-1;
    const timeNow = Date.now();

    if ( timeNow - np.mouseDownTime > np.LONGPRESS && np.mouseDown) {
        np.showLetter.textContent = 'Numeric Keypad';
        //we don't have access to which button because the 
        //button is not pushed until we FINISH the mouse click
        //mouse down + mouse up
    }

    if ( timeNow-np.timeLast > 400 && np.numPresses > 0 )
    {
        if (timeNow - np.mouseDownTime > np.LONGPRESS ) {
            np.textArray.push(np.presses[ln]);
        }
        else {
            if ( np.presses[ln] === np.BACKSPACE ) {
                np.textArray.pop();  //pop() is smart enough not to take the array index negative
            }
            else {
                np.textArray.push(np.latestLetter);
            }           
        }

        np.textOutput.textContent = np.textArray.join('')+'_';

        resetPresses();

        np.showLetter.textContent = 'Letter:';
  
        checkScroll();

    }
}

function resetPresses() {
        np.numPresses = 0;
        np.presses.length = 0;
        np.presses.push(np.init); //dummy value
}

function checkScroll() {
        if (np.textArray.length > 20 ) {
            np.lineLength ++;
            if ( np.lineLength%20 === 0 ) np.textOutput.scrollTop += 500;
        }
}

function addKeyPress( numpadKey, time ) {

    np.textOutput.scrollTop += 500;  //make sure we always scroll to bottom of textarea

    const numL = np.lettersByKey[numpadKey].length;
    let letter = np.lettersByKey[numpadKey][np.numPresses%numL];
    np.presses.push(numpadKey); 
    np.numPresses ++;
    const numP = np.presses.length;

    const dt = time - np.mouseDownTime;

    if ( numpadKey === np.BACKSPACE && dt <= np.LONGPRESS ) {
        np.textArray.pop();
        np.textOutput.textContent = np.textArray.join('') + '_';
        resetPresses();
        letter = 'Delete';
    }
    else if ( np.presses[np.numPresses] !== np.presses[np.numPresses-1]
         && np.presses[np.numPresses-1] !== np.init ) {

        resetPresses();

        np.presses.push(numpadKey);
 
        np.textArray.push(np.latestLetter);
        np.textOutput.textContent  = np.textArray.join('') + '_';
        letter = np.lettersByKey[numpadKey][np.numPresses%numL];
        np.numPresses = 1;

        checkScroll();

    }

    np.latestLetter = letter;
    np.timeLast = time;

    if ( letter === '\u00A0' ) letter = 'Space';  //remember it is nbsp type of space
    np.showLetter.textContent = 'Letter: ' + letter;

}

function displayNumPad() {

    let np={}; np.init='666'; np.BACKSPACE = '#'; np.LONGPRESS=700;
    np.tables = makeKeyCounts();
    np.lettersByKey = np.tables[2];
    np.numPresses = 0; np.timeLast = Date.now();
    np.presses = [np.init]; np.showLetter = document.getElementById('showLetter');
    np.textOutput = document.getElementById('output');
    np.buttons = []; np.screenMult = .4; np.textArray = [];
    np.lineLength = 0;
    
    np.mobile = false;
    if(/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)){
        np.mobile = true; np.screenMult = .96;
    }

    window.np = np;  //make np global

    const numpadKeys='123456789*0#';
    const numpad = document.getElementById('numpad');

    //generate vanilla html buttons dynamically here
    for (let i=0; i<numpadKeys.length; i++) {

        var b = document.createElement('input');
        b.type='button';
        b.id =numpadKeys[i];
        let buttonText = numpadKeys[i];
        buttonText += '\n';
        if (np.lettersByKey[numpadKeys[i]]) {
            buttonText += np.lettersByKey[numpadKeys[i]].join('');
        } 
        else { buttonText += ' '; }  //trick to get all buttons to match in size

        if ( numpadKeys[i] === '0' ) buttonText = '0\n_'; //ugly
        if ( numpadKeys[i] === '#' ) buttonText = '#\n<'; //uglier

        b.value = buttonText; 
        b.setAttribute('class','buttonClass01');

        b.onclick = function() { addKeyPress( numpadKeys[i], Date.now() ); };        
        numpad.appendChild(b);

    }
  
    //keep track of mousedown times so we can distinguish letters from numbers
    //also we only want mousedown events inside the numpad div
    numpad.addEventListener('mousedown', e=> {
        np.mouseDown = true;
        np.mouseDownTime = Date.now();
        //e.preventDefault();
    });

    numpad.addEventListener('mouseup', e=> {
        np.mouseDown = false;
        np.mouseUpTime = Date.now();
    });

    numpad.add
    
    numpad.addEventListener('touchstart', e=> {
        np.touchDown = true;
        np.touchDownTime = Date.now();
        np.mouseDownTime = Date.now();
        np.mouseDown = true;
    });
   
    numpad.addEventListener('touchend', e=> {
        np.touchDown = false;
        np.touchEndTime = Date.now();
        np.mouseDown = false;
        //checkPresses();
    });
    
    window.onresize = windowResize;  //window resize listener

    windowResize();  //call at startup for consistency sake

    //we need to detect how long it has been since no keys have been pressed
    setInterval( checkPresses, 100 );  
}


function windowResize(e) {

        //console.log(window.innerWidth, window.innerHeight);
        let numpadDiv = document.getElementById('numpad');
        let outDiv = document.getElementById('output');
        let showDiv = document.getElementById('showLetter');

        let dw = window.innerWidth*np.screenMult;
        const bw = Math.max(120, Math.trunc( dw / 3.2 ) );
        const bh = Math.trunc( bw * .7);
        dw = bw * 3.1;

        //probably keep an array of divs and loop through since
        //new style is same for all
        showDiv.setAttribute('style',`left:${dw+10}`);
        outDiv.setAttribute('style',`left:${dw+10}`);        

        numpadDiv.setAttribute('style',`width:${dw}; height:${bh}`);
          
        if ( 2*dw > window.innerWidth ) {
            const top = bh*4 + 10;
            const styleString = `position:relative; left: 0px; top:${top}px;`;
            showDiv.setAttribute('style', styleString);
            outDiv.setAttribute('style', styleString);
        }

        let buttons = numpadDiv.children;
        //the only children of the div are the buttons so just loop through
        for (let i=0; i<buttons.length; i++) {
            let button = buttons[i];
            button.setAttribute('style',`width:${bw}px; height:${bh}px;`); 
        }
       
}


</script>
</html>
